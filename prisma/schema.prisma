datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  password            String
  role                Role                 @default(USER)
  sessions            Session[]
  emailVerifiedAt     DateTime?
  verificationTokens  VerificationToken[]
  passwordResetTokens PasswordResetToken[]
  loginAttempts       LoginAttempt[]
  technician          Technician?
  workNotes           WorkNote[]
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
}

model Session {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  token     String
  valid     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model VerificationToken {
  id        String    @id @default(uuid())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String    @id @default(uuid())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([expiresAt])
}

model LoginAttempt {
  id             String    @id @default(uuid())
  user           User?     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String?
  emailLowercase String
  ipAddress      String
  failCount      Int       @default(0)
  lockedUntil    DateTime?
  firstFailedAt  DateTime  @default(now())
  lastFailedAt   DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([emailLowercase, ipAddress])
  @@index([lockedUntil])
}

enum Role {
  USER
  ADMIN
}

// FSM models

enum WorkOrderStatus {
  DRAFT
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum WorkOrderPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model Customer {
  id                  String            @id @default(cuid())
  name                String
  email               String?
  phone               String?
  billingAddressLine1 String?
  billingAddressLine2 String?
  billingCity         String?
  billingState        String?
  billingPostalCode   String?
  billingCountry      String?
  serviceLocations    ServiceLocation[]
  workOrders          WorkOrder[]
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
}

model ServiceLocation {
  id           String      @id @default(cuid())
  customer     Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId   String
  label        String?
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  postalCode   String?
  country      String?
  latitude     Float?
  longitude    Float?
  workOrders   WorkOrder[]
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([customerId])
}

model Technician {
  id          String      @id @default(cuid())
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String      @unique
  displayName String
  phone       String?
  workOrders  WorkOrder[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model WorkOrder {
  id                   String              @id @default(cuid())
  customer             Customer            @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customerId           String
  serviceLocation      ServiceLocation     @relation(fields: [serviceLocationId], references: [id], onDelete: Cascade)
  serviceLocationId    String
  assignedTechnician   Technician?         @relation(fields: [assignedTechnicianId], references: [id], onDelete: SetNull)
  assignedTechnicianId String?
  status               WorkOrderStatus     @default(DRAFT)
  priority             WorkOrderPriority   @default(NORMAL)
  summary              String
  description          String?
  scheduledStart       DateTime?
  scheduledEnd         DateTime?
  actualStart          DateTime?
  actualEnd            DateTime?
  notes                WorkNote[]
  lineItems            WorkOrderLineItem[]
  createdAt            DateTime            @default(now())
  updatedAt            DateTime            @updatedAt

  @@index([customerId])
  @@index([serviceLocationId])
  @@index([assignedTechnicianId])
}

model WorkNote {
  id           String    @id @default(cuid())
  workOrder    WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  workOrderId  String
  author       User      @relation(fields: [authorUserId], references: [id], onDelete: Cascade)
  authorUserId String
  body         String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([workOrderId])
  @@index([authorUserId])
}

model WorkOrderLineItem {
  id             String    @id @default(cuid())
  workOrder      WorkOrder @relation(fields: [workOrderId], references: [id], onDelete: Cascade)
  workOrderId    String
  description    String
  quantity       Int       @default(1)
  unitPriceCents Int
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([workOrderId])
}
